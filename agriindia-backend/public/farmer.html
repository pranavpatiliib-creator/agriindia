<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgriIndia Farmer Dashboard</title>
  <style>
    :root {
      --bg-1: #0c1f16;
      --bg-2: #163c2a;
      --bg-3: #255b3f;
      --glass: rgba(255, 255, 255, 0.14);
      --glass-2: rgba(255, 255, 255, 0.08);
      --line: rgba(255, 255, 255, 0.22);
      --text: #ecfdf1;
      --muted: #b5ddc3;
      --accent: #ffce57;
      --ok: #7bed9f;
      --card-shadow: 0 18px 40px rgba(0, 0, 0, 0.32);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", "Lucida Sans", Arial, sans-serif;
      background: radial-gradient(circle at 20% 10%, #2b7a4b 0%, transparent 25%),
                  radial-gradient(circle at 90% 25%, #315f97 0%, transparent 24%),
                  linear-gradient(145deg, var(--bg-1), var(--bg-2), var(--bg-3));
      background-attachment: fixed;
      overflow-x: hidden;
    }

    .orbs::before,
    .orbs::after {
      content: "";
      position: fixed;
      border-radius: 50%;
      filter: blur(12px);
      opacity: 0.28;
      z-index: 0;
      pointer-events: none;
      animation: drift 14s ease-in-out infinite alternate;
    }

    .orbs::before {
      width: 340px;
      height: 340px;
      background: #9ef0b7;
      left: -80px;
      top: 90px;
    }

    .orbs::after {
      width: 270px;
      height: 270px;
      background: #ffd47a;
      right: -70px;
      top: 280px;
      animation-duration: 18s;
    }

    @keyframes drift {
      from { transform: translateY(0px) translateX(0px); }
      to { transform: translateY(24px) translateX(16px); }
    }

    .app {
      position: relative;
      z-index: 1;
      width: min(1200px, 94vw);
      margin: 18px auto 40px;
    }

    .hero {
      backdrop-filter: blur(10px);
      background: linear-gradient(120deg, var(--glass), var(--glass-2));
      border: 1px solid var(--line);
      border-radius: 26px;
      padding: 22px;
      box-shadow: var(--card-shadow);
    }

    .hero-top {
      display: flex;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: clamp(26px, 4vw, 40px);
      letter-spacing: 0.4px;
      text-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 15px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill,
    select,
    input,
    button {
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(9, 24, 17, 0.52);
      color: var(--text);
      padding: 10px 12px;
    }

    input::placeholder { color: #b8d7c5; }

    button {
      background: linear-gradient(130deg, #2a8f56, #4cb072);
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      box-shadow: 0 8px 18px rgba(29, 110, 66, 0.35);
    }

    button:hover { transform: translateY(-1px); }

    .metrics {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(4, minmax(150px, 1fr));
      gap: 10px;
    }

    .metric {
      background: rgba(5, 20, 12, 0.42);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 14px;
      padding: 12px;
    }

    .metric-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .metric-value {
      margin-top: 6px;
      font-size: 26px;
      font-weight: 800;
      color: var(--accent);
    }

    .chart {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      min-height: 110px;
    }

    .bar {
      flex: 1;
      min-width: 70px;
      background: linear-gradient(180deg, #8af5ad, #1f8f56);
      border-radius: 12px 12px 4px 4px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 6px;
      color: #042911;
      font-weight: 700;
      box-shadow: inset 0 -18px 30px rgba(0, 0, 0, 0.18);
      transition: height 0.35s ease;
    }

    .bar-wrap { flex: 1; text-align: center; }
    .bar-label { margin-top: 8px; color: var(--muted); font-size: 12px; }

    .controls {
      margin: 16px 0;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr 0.8fr;
      gap: 10px;
    }

    .planner {
      margin: 10px 0 14px;
      background: rgba(6, 22, 14, 0.58);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 12px;
      display: grid;
      grid-template-columns: 1.3fr 0.8fr auto;
      gap: 10px;
      align-items: center;
    }

    .planner-output {
      margin-top: 10px;
      grid-column: 1 / -1;
      color: #dafbe5;
      font-size: 14px;
      white-space: pre-wrap;
      border-top: 1px dashed rgba(255, 255, 255, 0.18);
      padding-top: 10px;
    }

    .status {
      margin: 8px 0 16px;
      color: #cbf7d7;
      font-size: 14px;
      min-height: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .card {
      background: rgba(5, 20, 12, 0.56);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--card-shadow);
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 21px;
      color: #f5ffef;
    }

    .chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }

    .chip {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.12);
      color: #d9ffe6;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .line {
      margin: 4px 0;
      color: #e9f9ee;
      font-size: 14px;
    }

    .card button {
      margin-top: 10px;
      width: 100%;
      background: linear-gradient(130deg, #f0a93a, #ffd66f);
      color: #2e2007;
      box-shadow: 0 8px 16px rgba(190, 140, 47, 0.35);
    }

    .pick-btn {
      background: linear-gradient(130deg, #2a8f56, #4cb072) !important;
      color: #ecfdf1 !important;
      box-shadow: 0 8px 16px rgba(29, 110, 66, 0.35) !important;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 50;
    }

    .modal.show { display: flex; }

    .modal-content {
      width: min(860px, 96vw);
      max-height: 92vh;
      overflow: auto;
      background: #f2fff6;
      color: #16341f;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 16px 45px rgba(0, 0, 0, 0.4);
    }

    .modal h2 { margin: 0 0 10px; }
    .modal .sec { margin-bottom: 12px; }
    .modal pre {
      margin: 8px 0 0;
      background: #103624;
      color: #eafff2;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      line-height: 1.4;
      overflow: auto;
      max-height: 320px;
    }

    .danger-note {
      margin-top: 8px;
      color: #ffda9e;
      font-size: 13px;
    }

    .chat-shell {
      margin-top: 16px;
      background: rgba(6, 22, 14, 0.58);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .chat-shell.chat-hidden {
      display: none;
    }

    .chat-head {
      padding: 12px 14px;
      background: linear-gradient(120deg, #1a6a3f, #2f8d59);
      color: #f3fff8;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chat-close-btn {
      margin-left: auto;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(0, 0, 0, 0.2);
      color: #ecfdf1;
      border-radius: 999px;
      width: 30px;
      height: 30px;
      line-height: 1;
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .chat-body {
      height: 340px;
      overflow-y: auto;
      padding: 14px;
      background: radial-gradient(circle at 20% 20%, rgba(190, 240, 203, 0.08), transparent 30%),
                  radial-gradient(circle at 80% 80%, rgba(255, 215, 128, 0.08), transparent 26%),
                  rgba(7, 25, 16, 0.8);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 78%;
      padding: 8px 10px;
      border-radius: 10px;
      line-height: 1.35;
      white-space: pre-wrap;
      font-size: 14px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(130deg, #2ea062, #59c07f);
      color: #082312;
      border-bottom-right-radius: 2px;
    }

    .msg.bot {
      align-self: flex-start;
      background: #eefef3;
      color: #113221;
      border-bottom-left-radius: 2px;
    }

    .chat-input {
      padding: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.18);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      background: rgba(7, 25, 16, 0.85);
    }

    .chat-quick {
      padding: 8px 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      background: rgba(7, 25, 16, 0.85);
      border-top: 1px solid rgba(255, 255, 255, 0.14);
    }

    .quick-btn {
      border: 1px solid rgba(255, 255, 255, 0.24);
      background: rgba(255, 255, 255, 0.08);
      color: #d5fce3;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
    }

    .chat-toggle-btn {
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 60;
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      color: #ecfdf1;
      background: linear-gradient(130deg, #2a8f56, #4cb072);
      box-shadow: 0 12px 26px rgba(29, 110, 66, 0.45);
      cursor: pointer;
    }

    .chat-toggle-btn.chat-open { display: none; }

    @media (max-width: 980px) {
      .metrics { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .controls { grid-template-columns: 1fr; }
      .planner { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .hero { border-radius: 18px; }
    }
  </style>
</head>
<body>
  <div class="orbs"></div>
  <main class="app">
    <section class="hero">
      <div class="hero-top">
        <div>
          <h1 id="title">AgriIndia Farmer Dashboard</h1>
          <div class="subtitle" id="subtitle">Crop guidance, planning and support for your farm</div>
        </div>
        <div class="toolbar">
          <span class="pill" id="tokenLabel">Farmer Login Token (optional)</span>
          <input id="tokenInput" type="password" placeholder="Paste farmer login token to unlock protected crop data" />
          <button id="saveTokenBtn">Save</button>
          <select id="langSelect" title="Language">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="mr">Marathi</option>
          </select>
        </div>
      </div>

      <div class="metrics">
        <div class="metric"><div class="metric-label" id="m1l">Total Crops</div><div class="metric-value" id="m1">0</div></div>
        <div class="metric"><div class="metric-label" id="m2l">Rabi + Kharif</div><div class="metric-value" id="m2">0</div></div>
        <div class="metric"><div class="metric-label" id="m3l">Cash Crops</div><div class="metric-value" id="m3">0</div></div>
        <div class="metric"><div class="metric-label" id="m4l">Fruit Crops</div><div class="metric-value" id="m4">0</div></div>
      </div>

      <div class="chart" aria-label="crop category chart">
        <div class="bar-wrap"><div class="bar" id="barField" style="height:12px">0</div><div class="bar-label" id="barFieldLabel">Field</div></div>
        <div class="bar-wrap"><div class="bar" id="barCash" style="height:12px">0</div><div class="bar-label" id="barCashLabel">Cash</div></div>
        <div class="bar-wrap"><div class="bar" id="barFruit" style="height:12px">0</div><div class="bar-label" id="barFruitLabel">Fruit</div></div>
      </div>

      <div class="danger-note" id="note"></div>
    </section>

    <section class="controls">
      <input id="searchInput" placeholder="Search crop by name..." />
      <select id="typeFilter">
        <option value="all">All Types</option>
        <option value="field">Rabi + Kharif</option>
        <option value="cash">Cash</option>
        <option value="fruit">Fruit</option>
      </select>
      <select id="seasonFilter">
        <option value="all">All Seasons</option>
        <option value="Kharif">Kharif</option>
        <option value="Rabi">Rabi</option>
        <option value="Annual">Annual</option>
        <option value="Perennial">Perennial</option>
      </select>
    </section>

    <section class="planner">
      <input id="plannerCrop" readonly placeholder="Select crop from cards below" />
      <input id="acreInput" type="number" min="0" step="0.1" value="1" />
      <button id="planBtn">Estimate</button>
      <div class="planner-output" id="planOutput"></div>
    </section>

    <div class="status" id="status"></div>
    <section class="grid" id="grid"></section>

    <section class="chat-shell" id="chatShell">
      <div class="chat-head">
        <span id="chatTitle">Farmer Assistant Chat</span>
        <span id="chatState">Type a number or crop name to get guidance</span>
        <button id="chatHeaderClose" class="chat-close-btn" type="button" aria-label="Close Bot Chat" title="Close Bot Chat">×</button>
      </div>
      <div class="chat-body" id="chatBody"></div>
      <div class="chat-quick">
        <button id="qMenu" class="quick-btn" data-chat="menu">Menu</button>
        <button id="qCrop" class="quick-btn" data-chat="1">Crop Info</button>
        <button id="qIns" class="quick-btn" data-chat="2">Insurance</button>
        <button id="qSub" class="quick-btn" data-chat="3">Subsidy</button>
        <button id="qMsp" class="quick-btn" data-chat="5">MSP</button>
        <button id="qReset" class="quick-btn" data-chat="0">Reset</button>
      </div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Ask your farming question..." />
        <button id="chatSendBtn">Send</button>
      </div>
    </section>
    <button id="chatToggleBtn" class="chat-toggle-btn" type="button" aria-expanded="false">Open Bot Chat</button>
  </main>

  <div class="modal" id="modal">
    <div class="modal-content">
      <button style="float:right" id="closeModal">Close</button>
      <h2 id="modalTitle"></h2>
      <div class="sec" id="modalBody"></div>
    </div>
  </div>

  <script>
    const texts = {
      en: {
        title: "AgriIndia Farmer Dashboard",
        subtitle: "Crop guidance, planning and support for your farm",
        total: "Crops Available",
        field: "Field Crops (Rabi + Kharif)",
        cash: "Cash Crops",
        fruit: "Fruit Crops",
        allTypes: "All Types",
        search: "Search crop by name...",
        allSeasons: "All Seasons",
        loading: "Loading farmer crop data...",
        loaded: "Farmer data is ready.",
        partial: "Field crops loaded. Add farmer token to unlock protected crop lists.",
        error: "Unable to load data. Check backend server and DB connection.",
        details: "View Crop Details",
        season: "Season",
        sowing: "Sowing / Planting",
        harvesting: "Harvesting",
        seed: "Seed / Planting material",
        yield: "Yield",
        msp: "MSP / Price",
        fertilizer: "Fertilizer stages",
        irrigation: "Irrigation schedule",
        diseases: "Major diseases",
        pests: "Major pests",
        fullData: "Complete Crop Data (JSON)",
        noData: "No data",
        chatTitle: "Farmer Assistant Chat",
        chatState: "Type a number or crop name to get guidance",
        chatPlaceholder: "Ask your farming question...",
        send: "Send",
        tokenLabel: "Farmer Login Token (optional)",
        tokenPlaceholder: "Paste farmer login token to unlock protected crop data",
        plannerPlaceholder: "Select crop from cards below",
        planButton: "Estimate",
        selectCrop: "Use For Planning",
        plannerEmpty: "Select crop first, then press Estimate.",
        plannerTitle: "Farm Plan",
        plannerAcre: "Acre",
        plannerSeed: "Seed / Planting material needed",
        plannerYield: "Estimated total yield",
        tokenTip: "Tip: Add your farmer login token for complete crop access.",
        chatWelcome: "Welcome farmer. Send 'menu' to start.",
        noReply: "No response from assistant.",
        quickMenu: "Menu",
        quickCrop: "Crop Info",
        quickIns: "Insurance",
        quickSub: "Subsidy",
        quickMsp: "MSP",
        quickReset: "Reset",
        openChat: "Open Bot Chat",
        closeChat: "Close Bot Chat",
        chatServerIssue: "Assistant is unavailable right now.",
      },
      hi: {
        title: "एग्रीइंडिया किसान डैशबोर्ड",
        subtitle: "आपके खेत के लिए फसल मार्गदर्शन, योजना और सहायता",
        total: "उपलब्ध फसलें",
        field: "मैदानी फसलें (रबी + खरीफ)",
        cash: "नकदी फसलें",
        fruit: "फल फसलें",
        allTypes: "सभी प्रकार",
        search: "नाम से फसल खोजें...",
        allSeasons: "सभी सीजन",
        loading: "किसान फसल डेटा लोड हो रहा है...",
        loaded: "किसान डेटा तैयार है।",
        partial: "मैदानी फसलें लोड हो गईं। सुरक्षित फसल सूची खोलने के लिए किसान टोकन जोड़ें।",
        error: "डेटा लोड नहीं हुआ। बैकएंड सर्वर और DB कनेक्शन जांचें।",
        details: "पूरी जानकारी देखें",
        season: "सीजन",
        sowing: "बुवाई / रोपाई",
        harvesting: "कटाई",
        seed: "बीज / रोपण सामग्री",
        yield: "उपज",
        msp: "एमएसपी / कीमत",
        fertilizer: "उर्वरक चरण",
        irrigation: "सिंचाई अनुसूची",
        diseases: "मुख्य रोग",
        pests: "मुख्य कीट",
        fullData: "फसल का पूरा डेटा (JSON)",
        noData: "डेटा नहीं",
        chatTitle: "किसान सहायक चैट",
        chatState: "मार्गदर्शन के लिए नंबर या फसल का नाम लिखें",
        chatPlaceholder: "अपना खेती सवाल लिखें...",
        send: "भेजें",
        tokenLabel: "किसान लॉगिन टोकन (वैकल्पिक)",
        tokenPlaceholder: "सुरक्षित फसल डेटा खोलने के लिए किसान लॉगिन टोकन डालें",
        plannerPlaceholder: "नीचे कार्ड से फसल चुनें",
        planButton: "अनुमान निकालें",
        selectCrop: "योजना के लिए चुनें",
        plannerEmpty: "पहले फसल चुनें, फिर अनुमान निकालें दबाएं।",
        plannerTitle: "खेती योजना",
        plannerAcre: "एकड़",
        plannerSeed: "बीज / रोपण सामग्री आवश्यकता",
        plannerYield: "कुल अनुमानित उपज",
        tokenTip: "सुझाव: पूरी फसल सूची के लिए किसान लॉगिन टोकन जोड़ें।",
        chatWelcome: "स्वागत है किसान। शुरू करने के लिए 'menu' भेजें।",
        noReply: "सहायक से कोई जवाब नहीं मिला।",
        quickMenu: "मेनू",
        quickCrop: "फसल जानकारी",
        quickIns: "बीमा",
        quickSub: "सब्सिडी",
        quickMsp: "एमएसपी",
        quickReset: "रीसेट",
        openChat: "बॉट चैट खोलें",
        closeChat: "बॉट चैट बंद करें",
        chatServerIssue: "सहायक अभी उपलब्ध नहीं है।",
      },
      mr: {
        title: "अ‍ॅग्रीइंडिया शेतकरी डॅशबोर्ड",
        subtitle: "तुमच्या शेतासाठी पीक मार्गदर्शन, नियोजन आणि मदत",
        total: "उपलब्ध पिके",
        field: "मैदानी पिके (रबी + खरीप)",
        cash: "नगदी पिके",
        fruit: "फळ पिके",
        allTypes: "सर्व प्रकार",
        search: "नावाने पीक शोधा...",
        allSeasons: "सर्व हंगाम",
        loading: "शेतकरी पीक डेटा लोड होत आहे...",
        loaded: "शेतकरी डेटा तयार आहे.",
        partial: "फिल्ड पिके लोड झाली. सुरक्षित पीक सूचीसाठी शेतकरी टोकन जोडा.",
        error: "डेटा लोड झाला नाही. बॅकएंड आणि DB कनेक्शन तपासा.",
        details: "पूर्ण माहिती पहा",
        season: "हंगाम",
        sowing: "पेरणी / लागवड",
        harvesting: "कापणी",
        seed: "बियाणे / लागवड साहित्य",
        yield: "उत्पन्न",
        msp: "एमएसपी / किंमत",
        fertilizer: "खत टप्पे",
        irrigation: "सिंचन वेळापत्रक",
        diseases: "मुख्य रोग",
        pests: "मुख्य किडी",
        fullData: "पूर्ण पीक डेटा (JSON)",
        noData: "डेटा नाही",
        chatTitle: "शेतकरी सहाय्यक चॅट",
        chatState: "मार्गदर्शनासाठी क्रमांक किंवा पीक नाव टाइप करा",
        chatPlaceholder: "तुमचा शेतीचा प्रश्न लिहा...",
        send: "पाठवा",
        tokenLabel: "शेतकरी लॉगिन टोकन (पर्यायी)",
        tokenPlaceholder: "सुरक्षित पीक डेटा उघडण्यासाठी शेतकरी लॉगिन टोकन टाका",
        plannerPlaceholder: "खालील कार्डमधून पीक निवडा",
        planButton: "अंदाज काढा",
        selectCrop: "नियोजनासाठी निवडा",
        plannerEmpty: "पहिले पीक निवडा, मग अंदाज काढा दाबा.",
        plannerTitle: "शेती आराखडा",
        plannerAcre: "एकर",
        plannerSeed: "बियाणे / लागवड साहित्य आवश्यकता",
        plannerYield: "एकूण अंदाजे उत्पादन",
        tokenTip: "सूचना: पूर्ण पीक प्रवेशासाठी शेतकरी लॉगिन टोकन जोडा.",
        chatWelcome: "स्वागत आहे शेतकरी. सुरू करण्यासाठी 'menu' पाठवा.",
        noReply: "सहाय्याकडून उत्तर मिळाले नाही.",
        quickMenu: "मेन्यू",
        quickCrop: "पीक माहिती",
        quickIns: "विमा",
        quickSub: "अनुदान",
        quickMsp: "एमएसपी",
        quickReset: "रीसेट",
        openChat: "बॉट चॅट उघडा",
        closeChat: "बॉट चॅट बंद करा",
        chatServerIssue: "सहाय्यक सध्या उपलब्ध नाही.",
      }
    };

    const CHAT_LANGUAGE_CODE = { en: "1", mr: "2", hi: "3" };

    const state = { lang: "en", field: [], cash: [], fruit: [], crops: [], selectedCrop: null };
    const chatState = {
      from: localStorage.getItem("chatFrom") || "web-farmer-919999999999",
      busy: false,
      open: localStorage.getItem("farmerChatOpen") === "1",
      syncing: false,
      syncPromise: null,
      botLang: localStorage.getItem("farmerBotLang") || "",
    };

    function t(k) { return texts[state.lang][k] || texts.en[k] || k; }

    function pick(obj, key) {
      if (!obj || !key) return undefined;
      const byLang = obj[`${key}_${state.lang}`];
      if (byLang !== undefined && byLang !== null && byLang !== "") return byLang;
      const plain = obj[key];
      if (plain !== undefined && plain !== null && plain !== "") return plain;
      return undefined;
    }

    function apiBase() {
      return (localStorage.getItem("apiBaseUrl") || window.location.origin).replace(/\/+$/, "");
    }

    function token() {
      return localStorage.getItem("token") || "";
    }

    async function req(path, needToken = false) {
      const headers = {};
      if (needToken && token()) headers.Authorization = `Bearer ${token()}`;
      const res = await fetch(`${apiBase()}${path}`, { headers });
      return res;
    }

    function list(v) { return Array.isArray(v) ? v : []; }
    function val(v) { return v === undefined || v === null || v === "" ? "-" : v; }
    function esc(v) {
      return String(v === undefined || v === null ? "" : v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function normalizeCrop(raw, type) {
      const name = pick(raw, "name") || pick(raw, "crop_name");
      if (!name) return null;
      return {
        type,
        name,
        season: pick(raw, "season"),
        yieldPerAcre: pick(raw, "expected_yield_per_acre_quintals"),
        msp: pick(raw, "msp_rupees_per_quintal") || pick(raw, "average_market_price_rupees_per_quintal"),
        seedPerAcre: pick(raw, "seed_quantity_per_acre_kg") || pick(raw, "planting_material_quantity_per_acre"),
        fertilizerSchedule: list(raw?.fertilizer_schedule),
        majorDiseases: list(raw?.major_diseases),
        raw
      };
    }

    function rebuildCrops() {
      state.crops = [
        ...list(state.field).map((row) => normalizeCrop(row, "field")),
        ...list(state.cash).map((row) => normalizeCrop(row, "cash")),
        ...list(state.fruit).map((row) => normalizeCrop(row, "fruit")),
      ].filter(Boolean);
    }

    function setChatOpen(open, focusInput = false) {
      chatState.open = Boolean(open);
      localStorage.setItem("farmerChatOpen", chatState.open ? "1" : "0");
      const chatShell = document.getElementById("chatShell");
      const chatToggleBtn = document.getElementById("chatToggleBtn");
      chatShell.classList.toggle("chat-hidden", !chatState.open);
      chatToggleBtn.classList.toggle("chat-open", chatState.open);
      chatToggleBtn.setAttribute("aria-expanded", String(chatState.open));
      chatToggleBtn.textContent = chatState.open ? t("closeChat") : t("openChat");
      if (chatState.open && focusInput) {
        document.getElementById("chatInput").focus();
      }
    }

    function applyLanguage() {
      document.documentElement.lang = state.lang;
      document.getElementById("title").textContent = t("title");
      document.getElementById("subtitle").textContent = t("subtitle");
      document.getElementById("m1l").textContent = t("total");
      document.getElementById("m2l").textContent = t("field");
      document.getElementById("m3l").textContent = t("cash");
      document.getElementById("m4l").textContent = t("fruit");
      document.getElementById("barFieldLabel").textContent = t("field");
      document.getElementById("barCashLabel").textContent = t("cash");
      document.getElementById("barFruitLabel").textContent = t("fruit");
      document.getElementById("searchInput").placeholder = t("search");
      document.querySelector('#typeFilter option[value="all"]').textContent = t("allTypes");
      document.querySelector('#typeFilter option[value="field"]').textContent = t("field");
      document.querySelector('#typeFilter option[value="cash"]').textContent = t("cash");
      document.querySelector('#typeFilter option[value="fruit"]').textContent = t("fruit");
      document.querySelector('#seasonFilter option[value="all"]').textContent = t("allSeasons");
      document.getElementById("chatTitle").textContent = t("chatTitle");
      document.getElementById("chatState").textContent = t("chatState");
      document.getElementById("chatInput").placeholder = t("chatPlaceholder");
      document.getElementById("chatSendBtn").textContent = t("send");
      document.getElementById("tokenLabel").textContent = t("tokenLabel");
      document.getElementById("tokenInput").placeholder = t("tokenPlaceholder");
      document.getElementById("plannerCrop").placeholder = t("plannerPlaceholder");
      document.getElementById("planBtn").textContent = t("planButton");
      document.getElementById("qMenu").textContent = t("quickMenu");
      document.getElementById("qCrop").textContent = t("quickCrop");
      document.getElementById("qIns").textContent = t("quickIns");
      document.getElementById("qSub").textContent = t("quickSub");
      document.getElementById("qMsp").textContent = t("quickMsp");
      document.getElementById("qReset").textContent = t("quickReset");
      document.getElementById("chatToggleBtn").textContent = chatState.open ? t("closeChat") : t("openChat");
      document.getElementById("chatHeaderClose").setAttribute("aria-label", t("closeChat"));
      document.getElementById("chatHeaderClose").setAttribute("title", t("closeChat"));
      render();
    }

    function addBubble(kind, text) {
      const box = document.getElementById("chatBody");
      const div = document.createElement("div");
      div.className = `msg ${kind}`;
      div.textContent = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function decodeEntities(text) {
      const box = document.createElement("textarea");
      box.innerHTML = String(text || "");
      return box.value;
    }

    function stripTags(text) {
      return String(text || "").replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
    }

    function parseTwimlMessages(xmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "text/xml");
      const messageNodes = [...doc.getElementsByTagName("Message")];
      const bodyNodes = [...doc.getElementsByTagName("Body")];
      const raw = [
        ...messageNodes.map((n) => (n.textContent || "").trim()),
        ...bodyNodes.map((n) => (n.textContent || "").trim()),
      ].filter(Boolean);
      if (raw.length) return raw;

      // Fallback for parser errors or non-standard wrappers
      const regexHits = String(xmlText || "").match(/<Message[^>]*>([\s\S]*?)<\/Message>/gi) || [];
      return regexHits
        .map((x) => x.replace(/^<Message[^>]*>/i, "").replace(/<\/Message>$/i, ""))
        .map((x) => decodeEntities(stripTags(x)))
        .map((x) => x.trim())
        .filter(Boolean);
    }

    function parseBotReplies(text, contentType) {
      const payload = String(text || "");
      const ctype = String(contentType || "").toLowerCase();

      if (!payload.trim()) return [];

      if (ctype.includes("xml") || payload.trimStart().startsWith("<?xml") || payload.includes("<Response")) {
        return parseTwimlMessages(payload);
      }

      if (ctype.includes("json") || payload.trimStart().startsWith("{") || payload.trimStart().startsWith("[")) {
        try {
          const json = JSON.parse(payload);
          if (Array.isArray(json?.messages)) return json.messages.map((x) => String(x || "").trim()).filter(Boolean);
          if (Array.isArray(json?.replies)) return json.replies.map((x) => String(x || "").trim()).filter(Boolean);
          if (typeof json?.message === "string") return [json.message.trim()].filter(Boolean);
          if (typeof json?.reply === "string") return [json.reply.trim()].filter(Boolean);
          return [JSON.stringify(json)];
        } catch (_) {
          return [];
        }
      }

      const cleaned = stripTags(payload);
      return cleaned ? [cleaned] : [];
    }

    async function postWebhookMessage(payload) {
      const body = new URLSearchParams();
      body.set("From", chatState.from);
      body.set("Body", String(payload || "").trim());

      const res = await fetch(`${apiBase()}/api/whatsapp/webhook`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString(),
      });

      const raw = await res.text();
      const replies = parseBotReplies(raw, res.headers.get("content-type"));
      return { ok: res.ok, status: res.status, replies };
    }

    async function syncChatLanguage(showBotReply = false) {
      if (chatState.syncPromise) return chatState.syncPromise;

      chatState.syncPromise = (async () => {
        chatState.syncing = true;
        try {
          const langCode = CHAT_LANGUAGE_CODE[state.lang] || "1";
          // Reset current chat session then pick selected language.
          await postWebhookMessage("0");
          const result = await postWebhookMessage(langCode);

          if (!result.ok) {
            addBubble("bot", `${t("chatServerIssue")} (HTTP ${result.status})`);
            return;
          }

          chatState.botLang = state.lang;
          localStorage.setItem("farmerBotLang", state.lang);

          if (showBotReply && result.replies.length) {
            result.replies.forEach((msg) => addBubble("bot", msg));
          }
        } catch (_) {
          addBubble("bot", t("chatServerIssue"));
        } finally {
          chatState.syncing = false;
          chatState.syncPromise = null;
        }
      })();

      return chatState.syncPromise;
    }

    async function sendChatMessage(text) {
      const payload = String(text || "").trim();
      if (!payload || chatState.busy) return;

      if (chatState.botLang !== state.lang) {
        await syncChatLanguage(false);
      }

      chatState.busy = true;
      addBubble("user", payload);

      try {
        const result = await postWebhookMessage(payload);
        if (!result.ok) {
          const msg = result.replies[0] || `${t("chatServerIssue")} (HTTP ${result.status})`;
          addBubble("bot", msg);
          return;
        }
        if (!result.replies.length) {
          addBubble("bot", t("noReply"));
          return;
        }
        result.replies.forEach((msg) => addBubble("bot", msg));
      } catch (err) {
        addBubble("bot", `Chat error: ${err.message || err}`);
      } finally {
        chatState.busy = false;
      }
    }

    function updateMetrics() {
      const f = state.crops.filter((x) => x.type === "field").length;
      const c = state.crops.filter((x) => x.type === "cash").length;
      const r = state.crops.filter((x) => x.type === "fruit").length;
      const total = f + c + r;
      document.getElementById("m1").textContent = total;
      document.getElementById("m2").textContent = f;
      document.getElementById("m3").textContent = c;
      document.getElementById("m4").textContent = r;

      const max = Math.max(f, c, r, 1);
      const bars = [
        ["barField", f],
        ["barCash", c],
        ["barFruit", r]
      ];
      bars.forEach(([id, n]) => {
        const h = 14 + Math.round((n / max) * 92);
        const el = document.getElementById(id);
        el.style.height = `${h}px`;
        el.textContent = n;
      });
    }

    function render() {
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      const tf = document.getElementById("typeFilter").value;
      const sf = document.getElementById("seasonFilter").value;
      const grid = document.getElementById("grid");

      const rows = state.crops.filter((row) => {
        const name = String(row.name || "").toLowerCase();
        const season = String(row.season || "");
        if (q && !name.includes(q)) return false;
        if (tf !== "all" && row.type !== tf) return false;
        if (sf !== "all" && season.toLowerCase() !== sf.toLowerCase()) return false;
        return true;
      });

      if (!rows.length) {
        grid.innerHTML = `<article class="card"><h3>${esc(t("noData"))}</h3></article>`;
        return;
      }

      grid.innerHTML = rows.map((row, i) => {
        const chip = row.type === "field" ? t("field") : row.type === "cash" ? t("cash") : t("fruit");

        return `<article class="card">
          <div class="chips"><span class="chip">${esc(chip)}</span><span class="chip">${esc(val(row.season))}</span></div>
          <h3>${esc(row.name)}</h3>
          <div class="line"><strong>${esc(t("yield"))}:</strong> ${esc(val(row.yieldPerAcre))}</div>
          <div class="line"><strong>${esc(t("msp"))}:</strong> ${esc(val(row.msp))}</div>
          <button class="details-btn" data-index="${i}">${esc(t("details"))}</button>
          <button class="pick-btn" data-pick="${i}">${esc(t("selectCrop"))}</button>
        </article>`;
      }).join("");

      [...grid.querySelectorAll(".details-btn")].forEach((btn) => {
        btn.addEventListener("click", () => {
          const row = rows[Number(btn.dataset.index)];
          openModal(row);
        });
      });
      [...grid.querySelectorAll(".pick-btn")].forEach((btn) => {
        btn.addEventListener("click", () => {
          const row = rows[Number(btn.dataset.pick)];
          state.selectedCrop = row || null;
          document.getElementById("plannerCrop").value = row?.name || "";
          document.getElementById("planOutput").textContent = "";
        });
      });
    }

    function parseRangeAvg(text) {
      const s = String(text || "");
      const nums = s.match(/\d+(\.\d+)?/g);
      if (!nums || !nums.length) return null;
      const arr = nums.slice(0, 2).map(Number).filter((n) => !Number.isNaN(n));
      if (!arr.length) return null;
      if (arr.length === 1) return arr[0];
      return (arr[0] + arr[1]) / 2;
    }

    function runPlanner() {
      const out = document.getElementById("planOutput");
      const acres = Number(document.getElementById("acreInput").value);
      if (!state.selectedCrop) {
        out.textContent = t("plannerEmpty");
        return;
      }
      if (!acres || acres <= 0) {
        out.textContent = t("plannerEmpty");
        return;
      }

      const row = state.selectedCrop;
      const seedRaw = row.seedPerAcre;
      const yieldRaw = row.yieldPerAcre;

      const seedPerAcre = parseRangeAvg(seedRaw);
      const yieldPerAcre = parseRangeAvg(yieldRaw);
      const seedTotal = seedPerAcre ? (seedPerAcre * acres).toFixed(2) : null;
      const yieldTotal = yieldPerAcre ? (yieldPerAcre * acres).toFixed(2) : null;

      out.textContent = [
        `${t("plannerTitle")}: ${row.name || "-"}`,
        `${t("plannerAcre")}: ${acres}`,
        `${t("plannerSeed")}: ${seedTotal ? `${seedTotal}` : val(seedRaw)}`,
        `${t("plannerYield")}: ${yieldTotal ? `${yieldTotal}` : val(yieldRaw)}`,
      ].join("\\n");
    }

    function openModal(row) {
      const title = row?.name || "-";
      const fert = list(row?.fertilizerSchedule);
      const irr = list(row?.raw?.irrigation_schedule || row?.raw?.irrigationSchedule);
      const dis = list(row?.majorDiseases);
      const pests = list(row?.raw?.major_pests || row?.raw?.pests);
      const fertHtml = fert.length
        ? fert.map((f) => `<li>${esc(val(pick(f, "stage") || pick(f, "application_period")))} - ${esc(val(pick(f, "fertilizer_name")))} (${esc(val(pick(f, "dosage_per_acre")))})</li>`).join("")
        : `<li>${esc(t("noData"))}</li>`;
      const irrHtml = irr.length
        ? irr.map((i) => `<li>${esc(val(pick(i, "growth_stage")))} - ${esc(val(pick(i, "interval_days")))} / ${esc(val(pick(i, "water_requirement")))}</li>`).join("")
        : `<li>${esc(t("noData"))}</li>`;
      const disHtml = dis.length
        ? dis.map((d) => `<li>${esc(val(pick(d, "disease_name")))} - ${esc(val(pick(d, "symptoms")))}</li>`).join("")
        : `<li>${esc(t("noData"))}</li>`;
      const pestHtml = pests.length
        ? pests.map((p) => `<li>${esc(val(pick(p, "pest_name")))} - ${esc(val(pick(p, "damage_symptoms")))}</li>`).join("")
        : `<li>${esc(t("noData"))}</li>`;
      const rawJson = esc(JSON.stringify(row?.raw || {}, null, 2));

      document.getElementById("modalTitle").textContent = title;
      document.getElementById("modalBody").innerHTML = `
        <div class="sec"><strong>${esc(t("season"))}:</strong> ${esc(val(row?.season))}</div>
        <div class="sec"><strong>${esc(t("sowing"))}:</strong> ${esc(val(pick(row?.raw, "sowing_time") || pick(row?.raw, "sowing_or_planting_time")))}</div>
        <div class="sec"><strong>${esc(t("harvesting"))}:</strong> ${esc(val(pick(row?.raw, "harvesting_time")))}</div>
        <div class="sec"><strong>${esc(t("seed"))}:</strong> ${esc(val(row?.seedPerAcre))}</div>
        <div class="sec"><strong>${esc(t("yield"))}:</strong> ${esc(val(row?.yieldPerAcre))}</div>
        <div class="sec"><strong>${esc(t("msp"))}:</strong> ${esc(val(row?.msp))}</div>
        <div class="sec"><strong>${esc(t("fertilizer"))}:</strong><ul>${fertHtml}</ul></div>
        <div class="sec"><strong>${esc(t("irrigation"))}:</strong><ul>${irrHtml}</ul></div>
        <div class="sec"><strong>${esc(t("diseases"))}:</strong><ul>${disHtml}</ul></div>
        <div class="sec"><strong>${esc(t("pests"))}:</strong><ul>${pestHtml}</ul></div>
        <div class="sec"><strong>${esc(t("fullData"))}:</strong><pre>${rawJson}</pre></div>
      `;
      document.getElementById("modal").classList.add("show");
    }

    async function load() {
      document.getElementById("status").textContent = t("loading");
      document.getElementById("note").textContent = "";

      let partial = false;
      try {
        const fieldRes = await req("/api/crops?sync=true");
        if (!fieldRes.ok) throw new Error("field crops failed");
        state.field = list(await fieldRes.json());

        const cashRes = await req("/api/cash-crops", true);
        if (cashRes.ok) {
          const j = await cashRes.json();
          state.cash = Array.isArray(j) ? j : list(j.data);
        } else {
          state.cash = [];
          partial = true;
        }

        const fruitRes = await req("/api/fruit-crops", true);
        if (fruitRes.ok) {
          const j = await fruitRes.json();
          state.fruit = Array.isArray(j) ? j : list(j.data);
        } else {
          state.fruit = [];
          partial = true;
        }

        rebuildCrops();
        updateMetrics();
        render();
        document.getElementById("status").textContent = partial ? t("partial") : t("loaded");
        document.getElementById("note").textContent = partial ? t("tokenTip") : "";
      } catch (e) {
        document.getElementById("status").textContent = t("error");
        document.getElementById("note").textContent = String(e.message || e);
      }
    }

    document.getElementById("closeModal").addEventListener("click", () => {
      document.getElementById("modal").classList.remove("show");
    });

    document.getElementById("modal").addEventListener("click", (e) => {
      if (e.target.id === "modal") document.getElementById("modal").classList.remove("show");
    });

    document.getElementById("saveTokenBtn").addEventListener("click", () => {
      const v = document.getElementById("tokenInput").value.trim();
      if (v) localStorage.setItem("token", v);
      else localStorage.removeItem("token");
      load();
    });
    document.getElementById("planBtn").addEventListener("click", runPlanner);

    document.getElementById("chatSendBtn").addEventListener("click", () => {
      const input = document.getElementById("chatInput");
      const value = input.value;
      input.value = "";
      sendChatMessage(value);
    });

    document.getElementById("chatInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("chatSendBtn").click();
      }
    });

    document.getElementById("chatToggleBtn").addEventListener("click", () => {
      setChatOpen(!chatState.open, true);
    });

    document.getElementById("chatHeaderClose").addEventListener("click", () => {
      setChatOpen(false);
    });

    [...document.querySelectorAll(".quick-btn")].forEach((btn) => {
      btn.addEventListener("click", () => sendChatMessage(btn.dataset.chat || ""));
    });

    document.getElementById("langSelect").addEventListener("change", (e) => {
      state.lang = e.target.value;
      localStorage.setItem("farmerLang", state.lang);
      applyLanguage();
      syncChatLanguage(true);
    });

    ["searchInput", "typeFilter", "seasonFilter"].forEach((id) => {
      document.getElementById(id).addEventListener("input", render);
      document.getElementById(id).addEventListener("change", render);
    });

    (function init() {
      const savedLang = localStorage.getItem("farmerLang");
      if (savedLang && ["en", "hi", "mr"].includes(savedLang)) {
        state.lang = savedLang;
        document.getElementById("langSelect").value = savedLang;
      }
      const savedToken = localStorage.getItem("token");
      if (savedToken) document.getElementById("tokenInput").value = savedToken;
      applyLanguage();
      setChatOpen(chatState.open);
      load();
      addBubble("bot", t("chatWelcome"));
    })();
  </script>
</body>
</html>
